<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Videos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      /* Reuse small set of layout styles for consistent look */
      body { background: linear-gradient(180deg,#0b0611,#12051a); color: #f7e9ff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
      .wrap { min-height: 100vh; display: grid; place-items: center; padding: 28px 14px; }
      .cardShell { width: min(920px, 96vw); border-radius: 18px; padding: 1px; background: conic-gradient(from 180deg, rgba(255,79,216,0.85), rgba(181,140,255,0.7)); box-shadow: 0 18px 60px rgba(0,0,0,0.55); }
      .card { background: linear-gradient(180deg, rgba(20,10,31,0.92), rgba(16,7,26,0.92)); border-radius: 17px; padding: 22px; }
      a { color: rgba(255,134,234,0.95); }
      .sub { color: rgba(247,233,255,0.72); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="cardShell">
        <div class="card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h2 class="mb-0">Videos</h2>
              <div class="sub">Search YouTube and save favorites</div>
            </div>
            <div>
              <a href="/" class="btn btn-sm btn-outline-light">Home</a>
            </div>
          </div>

          <!-- Search area -->
          <form class="row g-2 mb-3" method="get" action="/videos">
            <div class="col-md-9 col-8">
              <input type="text" name="q" value="<%= query %>" class="form-control" placeholder="Search YouTube videos..." />
            </div>
            <div class="col-md-3 col-4 d-grid">
              <button class="btn btn-primary" type="submit">Search</button>
            </div>
          </form>

          <% if (error) { %>
            <div class="alert alert-warning text-dark"><%= error %></div>
          <% } %>

          <% if (searchResult && searchResult.items && searchResult.items.length) { %>
            <h5 class="mt-3">Results</h5>
            <div class="row row-cols-1 row-cols-md-2 g-3 mb-4">
              <% searchResult.items.forEach(function(item){ %>
                <div class="col">
                  <div class="card text-dark">
                    <div class="row g-0">
                      <div class="col-4">
                        <% if (item.thumbnail) { %>
                          <img src="<%= item.thumbnail %>" class="img-fluid rounded-start" alt="thumb">
                        <% } %>
                      </div>
                      <div class="col-8">
                        <div class="card-body">
                          <h6 class="card-title"><%= item.title %></h6>
                          <p class="card-text text-truncate"><%= item.description %></p>
                          <div class="d-flex gap-2">
                            <form method="post" action="/videos/save">
                              <input type="hidden" name="videoId" value="<%= item.videoId %>" />
                              <input type="hidden" name="title" value="<%= item.title %>" />
                              <input type="hidden" name="thumbnail" value="<%= item.thumbnail %>" />
                              <input type="hidden" name="description" value="<%= item.description %>" />
                              <input type="hidden" name="_returnTo" value="?q=<%= encodeURIComponent(query) %>" />
                              <button class="btn btn-success btn-sm" type="submit">Save</button>
                            </form>
                            <a href="https://www.youtube.com/watch?v=<%= item.videoId %>" target="_blank" class="btn btn-outline-secondary btn-sm">Open</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else if (query) { %>
            <div class="alert alert-secondary">No results for "<%= query %>"</div>
          <% } %>

          <!-- Saved favorites (bottom) -->
          <h5 class="mt-4">Saved Favorites</h5>
          <% if (favorites && favorites.length) { %>
            <div id="favorites-list" class="list-group mb-3">
              <% favorites.forEach(function(f){ %>
                <div class="list-group-item d-flex align-items-start justify-content-between bg-transparent border-secondary" draggable="true" data-id="<%= f.id %>">
                  <div class="d-flex align-items-center gap-3">
                    <% if (f.thumbnail) { %>
                      <img src="<%= f.thumbnail %>" width="88" height="50" class="img-thumbnail" alt="thumb">
                    <% } %>
                    <div>
                      <div><strong><a href="https://www.youtube.com/watch?v=<%= f.videoId %>" target="_blank" class="link-light"><%= f.title %></a></strong></div>
                      <div class="text-muted"><small><%= new Date(f.createdAt).toLocaleString() %></small></div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <form method="post" action="/videos/delete/<%= f.id %>" onsubmit="return confirm('Delete this favorite?');">
                      <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                    </form>
                  </div>
                </div>
              <% }) %>
            </div>

            <script>
              (function(){
                const list = document.getElementById('favorites-list');
                let draggingEl = null;

                function getDragAfterElement(container, y) {
                  const draggableElements = [...container.querySelectorAll('[draggable]:not(.dragging)')];
                  let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
                  for (const child of draggableElements) {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                      closest = { offset, element: child };
                    }
                  }
                  return closest.element;
                }

                list.addEventListener('dragstart', (e) => {
                  const li = e.target.closest('[data-id]');
                  if (!li) return;
                  draggingEl = li;
                  li.classList.add('dragging');
                  e.dataTransfer.effectAllowed = 'move';
                });

                list.addEventListener('dragend', (e) => {
                  if (draggingEl) draggingEl.classList.remove('dragging');
                  draggingEl = null;
                });

                list.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  const after = getDragAfterElement(list, e.clientY);
                  if (!after) list.appendChild(draggingEl);
                  else list.insertBefore(draggingEl, after);
                });

                list.addEventListener('drop', (e) => {
                  e.preventDefault();
                  // send order to server
                  const ids = [...list.querySelectorAll('[data-id]')].map(li => parseInt(li.dataset.id));
                  fetch('/videos/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderedIds: ids })
                  }).then(res => res.json())
                    .then(json => {
                      if (!json.ok) alert('Failed to save order');
                    }).catch(err => {
                      console.error(err);
                      alert('Failed to save order');
                    });
                });
              })();
            </script>

          <% } else { %>
            <div class="alert alert-light text-dark">No favorites saved yet.</div>
          <% } %>

        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>